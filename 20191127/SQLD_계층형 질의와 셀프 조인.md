# SQLD_계층형 질의와 셀프 조인

## 계층형 질의

- 테이블에 계층형 데이터가 존재하는 경우 데이터를 조회하기 위해서 계층형 질의 사용



### 계층형 데이터

- 동일 테이블에 계층적으로 상위와 하위 데이터가 포함된 데이터
- 엔터티를 순환관계 데이터 모델로 설계할 경우 계층형 데이터 발생



### Oracle 계층형 질의

|     가상 칼럼      |                             설명                             |
| :----------------: | :----------------------------------------------------------: |
|       LEVEL        | 루트 데이터면 1, 그 하위 데이터면 2이다. 리프 데이터까지 1씩 증가 |
| CONNECT_BY_ISLEAF  | 전개 과정에서 해당 데이터가 리프 데이터이면 1, 그렇지 않으면 0이다. |
| CONNECT_BY_ISCYCLE | 전개 과정에서 자식을 갖는데, 해당 데이터가 조상으로서 존재하면 1, 그렇지 않으면 0이다. 여기서 조상이란 자신으로부터 루트까지의 경로에 존재하는 데이터를 말한다. CYCLE 옵션을 사용했을 때만 사용할 수 있다. |

- START WITH 절 ( 액세스 )

  - 계층 구조 전개의 시작 위치를 지정하는 구문, 즉, 루트 데이터 지정

- CONNECT BY 절 (조인)

  - 다음에 전개될 자식 데이터를 지정하는 구문
  - 자식 데이터는 CONNECT BY 절에 주어진 조건 만족

- PRIOR

  - CONNECT BY절에 사용되며, 현재 읽은 칼럼 지정
  - PRIOR 자식 = 부모 형태 시, 자식 데이터에서 부모 데이터 방향으로 전개하는 순방향 전개
  - PRIOR 부모 = 자식 형태 시, 부모 데이터에서 자식 데이터 방향으로 전개하는 역방향 전개

- NOCYCLE

  - 데이터 전개 시, 이미 나타났던 동일한 데이터가 전개 중에 다시 나타난다면 이것을 사이클 형성이라 한다.
  - 사이클이 발생한 데이터는 런타임 오류 발생
    - 사이클이 발생한 이후의 데이터는 전개하지 않음
    - ORDER SIBLINGS BY
      - 형제 노드에서 정렬 수행
      - WHERE
        - 모든 전개를 수행한 후에 지정된 조건을 만족하는 데이터만 추출

- 계층형 질의에서 사용되는 함수

  |        함수         |                             설명                             |
  | :-----------------: | :----------------------------------------------------------: |
  | SYS_CONNECT_BY_PATH |  루트 데이터부터 현재 전개할 데이터까지의 경로를 표시한다.   |
  |   CONNECT_BY_ROOT   | 현재 전개할 데이터의 루트 데이터를 표시한다. 단항 연산자이다. |

  

## 셀프 조인

- 동일 테이블 사이의 조인을 말한다.

  - FROM절에 동일 테이블이 두 번 이상 나타난다.
  - 테이블 별칭을 사용

- 사용법

  ```sql
  SELECT WORKER.ID 사원번호, WORKER.NAME 사원명, MANAGER.NAME 관리자명
  FROM EMP WORKER, EMP MANAGER
  WHERE WORKER.MGR = MANAGER.ID
  ```

- OUTER JOIN 방법도 있음

  ```sql
  SELECT WORKER.ID 사원번호, WORKER.NAME 사원명, MANAGER.NAME 관리자명
  FROM EMP WORKER LEFT OUTER JOIN EMP MANAGER ON ( WORKER.관리자 = MANAGER.사원 )
  ```

  
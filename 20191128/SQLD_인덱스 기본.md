# SQLD_인덱스 기본

## 인덱스 특징과 종류

- 인덱스는 원하는 데이터를 쉽게 찾을 수 있도록 돕는 책의 찾아보기와 유사한 개념
- INSERT, UPDATE, DELETE 등과 같은 DML 작업은 테이블과 인덱스를 함께 변경해야 하기 때문에 오히려 느려질 수 있다는 단점이 존재한다.

### 트리 기반 인덱스

- DBMS에서 가장 일반적인 인덱스는 B-트리 인덱스이다.
- B-트리 인덱스 = 브랜치 블록과 리프 블록
  - 브랜치 블록 중에서 가장 상위에 있는 블록을 루트 블록
  - 브랜치 블록은 다음 단계의 블록을 가리키는 포인터를 가지고 있다.
  - 리프 블록은 트리의 가장 아래 단계에 존재
  - 리프 블록은 인덱스를 구성하는 칼럼의 데이터와 해당 데이터를 가지고 있는 행의 위치를 가리키는 레코드 식별자 구성
  - 인덱스 데이터는 인덱스를 구성하는 칼럼의 값으로 정렬된다.
  - 리프 블록은 양방향 링크를 가지고 있다.
    - 이것을 통해서 오름 차순과 내림 차순 검색을 쉽게 할 수 있다.
  - '='로 검색하는 일치 검색과 'BETWEEN', '>' 등과 같은 연산자로 검색하는 범위 검색 모두에 적합한 구조
- 비트맵 인덱스
- 리버스 키 인덱스
- 함수기반 인덱스



### SQL SERVER의 클러스터형 인덱스

- 저장 구조에 따라 클러스터형 인덱스와 비클러스터형 인덱스로 나눈다.
- 클러스터형 인덱스
  - 첫째, 인덱스의 리프 페이지가 곧 데이터 페이지다.
  - 따라서 테이블 탐색에 필요한 레코드 식별자가 리프 페이지에 없다.
    - 인덱스 키 칼럼과 나머지 칼럼을 리프 페이지에 같이 저장하기 때문에 테이블을 랜덤 액세스 할 필요가 없다.
  - 클러스터형 인덱스의 리프 페이지를 탐색하면 해당 테이블의 모든 칼럼 값을 곧바로 얻을 수 있다.
  - 둘째, 리프 페이지의 모든 로우는 인덱스 키 칼럼 순으로 물리적으로 정렬되어 저장된다.
    - 테이블 로우는 물리적으로 한 가지 순서로만 정렬될 수 있다.
    - 그러므로 클러스터형 인덱스는 테이블당 한 개만 생성할 수 있다.



## 전체 테이블 스캔과 인덱스 스캔

### 전체 테이블 스캔

- 전체 테이블 스캔 방식으로 데이터를 검색한다는 것은 테이블에 존재하는 모든 데이터를 읽어 가면서 조건에 맞으면 결과로서 추출하고 조건에 맞지 않으면 버리는 방식으로 검색한다.
- 고수위 마크까지의 블록 내 모든 데이터를 읽어야 하기 때문에 모든 결과를 찾을 때까지 시간이 오래 걸릴 수 있다.
  - 테이블에 존재하는 모든 블록의 데이터를 읽는다.
  - 재사용성이 떨어진다.
  - 읽은 블록들은 메모리에서 곧 제거될 수 있도록 관리된다.
- 옵티마이저가 연산으로서 전체 테이블 스캔 방식을 선택하는 이유
  - SQL문에 조건이 존재하지 않은 경우
    - SQL문에 조건이 존재하지 않는다는 것은 테이블에 존재하는 모든 데이터가 답이 된다는 것이다.
  - SQL문의 주어진 조건에 사용 가능한 인덱스가 존재하지 않는 경우
    - 주어진 조건에 사용 가능한 인덱스는 존재하나 함수를 사용하여 인덱스 칼럼을 변형한 경우에도 인덱스를 사용할 수 없다.
  - 옵티마이저의 취사 선택
    - 조건을 만족하는 데이터가 많은 경우, 결과를 추출하기 위해서 테이블의 대부분의 블록을 액세스해야 한다고 옵티마이저가 판단하면 조건에 사용 가능한 인덱스가 존재해도 전체 테이블 스캔 방식으로 읽을 수 있다.
  - 그 밖의 경우
    - 병렬처리 방식으로 처리하는 경우 또는 전체 테이블 스캔 방식의 힌트를 사용한 경우



### 인덱스 스캔

- 인덱스의 리프 블록은 인덱스 구성하는 칼럼과 레코드 식별자로 구성되어 있다.
- 검색을 위해 인덱스의 리프 블록을 읽으면 인덱스 구성 칼럼의 값과 테이블의 레코드 식별자를 알 수 있다.
- 인덱스는 인덱스 구성 칼럼의 순서로 정렬
- 인덱스 유일 스캔
  - 유일 인덱스를 사용하여 단 하나의 데이터를 추출하는 방식
  - 중복을 허락하지 않는 인덱스
  - 구성 칼럼은 모두 '='로 값이 주어지면 결과는 최대 1건이 된다.
- 인덱스 범위 스캔
  - 인덱스를 이용하여 한 건 이상의 데이터를 추출하는 방식
  - 유일 인덱스의 구성 칼럼 모두에 대해 '='로 값이 주어지지 않는 경우
  - 비유일 인덱스를 이용하는 모든 액세스 방식은 인덱스 범위 스캔 방식으로 데이터를 액세스 하는 것이다.
- 인덱스 역순 범위 스캔
  - 리프 블록의 양방향 링크를 이용하여 내림 차순으로 데이터를 읽는 방식
  - 최대값을 쉽게 찾을 수 있다.
- 기타방식들
  - 인덱스 전체 스캔, 인덱스 고속 전체 스캔, 인덱스 스킵 스캔



### 전체 테이블 스캔과 인덱스 스캔 방식의 비교

- 인덱스 스캔은 인덱스에 존재하는 레코드 식별자를 이용해서 검색하는 데이터의 정확한 위치를 알고 데이터를 읽는다.
  - 한번의 I/O 요청에 한 블록씨 데이터를 읽는다.
- 전체 테이블 스캔은 테이블의 모든 데이터를 읽으면서 원하는 데이터를 찾아야 하기 때문에 비효율적인 검색을 하게 된다.
  - 반대로 테이블의 대부분의 데이터를 찾을 때는 한 블록씩 읽는 인덱스 스캔 방식보다는 어차피 대부분의 데이터를 읽을 거라면 한번에 여러 블록씩 읽는 전체 테이블 스캔 방식이 유리할 수 있다.
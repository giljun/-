# SQLD_절차형 SQL

## 절차형 SQL 개요

- 일반적인 개발 언어처럼 SQL에도 절차 지향적인 프로그램이 가능하도록 DBMS 벤더별로 절차형 SQL 제공
- PL/SQL
- T-SQL
- 절차형 SQL을 이용하면 SQL문의 연속적인 실행이나 조건에 따른 분기처리를 이용하여 특정 기능을 수행하는 저장 모듈 생성가능
  - Procedure
  - User Defined Function
  - Trigger



## PL/SQL 개요

### 특징

- Block 구조
  - DML 문장과 QUERY 문장
  - 절차형 언어 등을 사용할 수 있음
  - 트랜잭션 언어
- 다양한 저장 모듈을 개발할 수 있다.
- 변수, 상수 선언 가능
- 정의 에러나 사용자 정의 에러를 정의하여 사용할 수 있다.
- 응용 프로그램의 성능을 향상시킨다.
- 여러 SQL 문장을 Block으로 묶고 한 번에 서버로 보내기 때문에 통신량을 줄인다.



### 구조

- 선언부
- 실행부
- 예외 처리부



### PL/SQL 기본 문법

```sql
CREATE OR REPLACE Procedure Procedure_name ( argument1 mode data type1, ... ) IS AS ... ... BEGIN ... ... EXCEPTION ... ... END; /
```

- 프로시저는 개발자가 자주 실행해야 하는 로직을 절차적인 언어를 이용하여 작성한 프로그램 모듈이기 때문에 필요할때 호출하여 실행할 수 있다.
- OR REPLACE 절은 데이터베이스 내에 같은 이름의 프로시저가 있는 경우, 기존의 프로시저를 무시하고 새로운 내용으로 덮어쓰기 하겠다는 의미이다.
- Argument는 프로시저가 호출될 때 프로시저 안으로 어떤 값이 들어오거나 혹은 프로시저에서 처리한 결과값을 운영 체제로 리턴시킬 매개 변수를 지정할 때 사용한다.
- IN, OUT, INOUT
- "/"
  - 프로시저를 컴파일하라는 명령어



## T-SQL

### 특징

- 변수 선언 기능
  - @@ 전역 변수 / @ 지역 변수
  - 전역변수는 내장 / 지역 변수는 임시 변수
- 데이터 유형을 제공한다.
- 연산자 사용이 가능
- 흐름 제어 기능 사용 가능
- 주석 사용 가능



### PL/SQL 기본 문법

```sql
CREATE Procedure schema_name.Procedure_name @parameter1 data_type1 mode, ... WITH AS ... ... BEGIN... ...ERROR 처리 ... ...END;
```

- 프로시저의 변경이 필요할 경우
  - ALTER 구문으로 변경
- 매개변수 유형 4가지
  - VARYING 결과 집합이 출력 매개 변수로 사용되도록 지정
    - CURSOR 매개변수에만 적용
  - DEFAULT 지정된 매개 변수가 프로시저를 호출할 당시 지정되지 않을 경우 지정된 기본값으로 처리한다.
  - OUT, OUTPUT 프로시저에서 처리한 결과 값을 EXECUTE 문 호출 시 반환한다.
  - READONLY 자주 사용되지 않는다.
- WITH 부분에 지정할 수 있는 옵션 3가지
  - RECOMPILE
    - 데이터베이스 엔진에서 현재 프로시저의 계획을 캐시하지 않고 프로시저가 런타임에 컴파일 된다. 데이터베이스 엔진에서 저장 프로시저 안에 있는 개별 쿼리에 대한 계획을 삭제하려 할 때 RECOMPILE 쿼리 힌트를 사용한다.
  - ENCRYPTIONCREATE PROCEDURE 
    - 원본 텍스트가 알아보기 어려운 형식으로 변환된다.
    - 원본을 볼 수 있는 방법은 없으므로, 반드시 백업을 해야된다.
  - EXECUTE AS 해당 저장 프로시저를 실행할 보안 컨텍스트를 지정한다.



## 프로시저 주의사항

1. PL/SQL 및 T-SQL에서는 다양한 변수가 있다. 
   1. cnt라는 SCALAR 변수라고 한다.
      1. 임시 데이터를 하나만 저장할 수 있는 변수이며, 거의 모든 형태의 데이터  유형을 지정할 수 있다.
2. SELECT 문장은 반드시 결과값이 있어야 하며, 그 결과는 반드시 하나여야 한다.
   1. 조회 결과가 없거나 하나 이상인 경우에는 에러를 발생시킨다.
   2. T-SQL에서는 결과 값이 없어도 에러가 발생하지 않는다.
3. 대입연산자 "="를 사용하지만, PL/SQL에서는 ":="를 사용한다.
4. 에러 처리를 담당하는 EXCEPTION에는 WHEN ~ THEN 절을 사용하여 에러의 종류별로 적절히 처리한다.



## User Defined Function의 생성과 활용

- 절차형 SQL을 로직과 함께 데이터베이스 내에 저장해 놓은 명령문의 집합을 의미한다.
- 반드시 하나의 값을 되돌려줘야 한다.



## Trigger의 생성과 활용

- 특정 테이블에 INSERT, UPDATE, DELETE와 같은 DML 문이 수행되었을 때, 데이터베이스에서 자동으로 동작하도록 작성된 프로그램이다.
- 즉 사용자가 직접 호출하여 사용하는 것이 아니고 데이터베이스에서 자동적으로 수행하게 된다.
- 전체 트랜잭션 작업에 대해 발생되는 Trigger와 각 행에 대해서 발생되는 Trigger가 있다.
- 하나의 트랜잭션 안에서 일어나는 일련의 작업들
- 데이터베이스의 보안의 적용, 유효하지 않은 트랜잭션의 예방, 업무 규칙 자동 적용 제공 등에 사용될 수 있다.



## 프로시저와 트리거의 차이점

- 프로시저
  - EXECUTE 명령어로 실행
  - COMMIT, ROLLBACK 실행 가능
- 트리거
  - 생성 후 자동으로 실행
  - COMMIT, ROLLBACK 실행 안됨








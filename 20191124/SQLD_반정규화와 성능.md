# SQLD_반정규화와 성능

## 반정규화를 통한 성능 향상 전략

### 반정규화의 정의

- 반정규화
  - 정규화된 엔터티, 속성, 관계에 대해 시스템의 성능향상, 개발과 운영의 단순화를 위해 중복, 통합, 분리 등을 수행하는 데이터 모델링의 기법
  - 협의의 반정규화
    - 데이터를 중복하여 성능을 향상
  - 좀 더 넓은 의미의 반정규화
    - 성능을 향상시키기 위해 정규화된 데이터 모델에서 중복, 통합, 분리 등을 수행하는 모든 과정
- 데이텉 무결성이 깨질 수 있는 위험을 무릅쓰고 데이터를 중복하여 반정규화를 적용하는 이유
  - 데이터를 조회할 때 디스크 I/O량이 많아서 성능이 저하
  - 경로가 너무 멀어 조인으로 인한 성능저하가 예상
  - 칼럼을 계산하여 읽을 때 성능이 저하될 것을 예상
- 정규화만을 수행하면 엔터티의 갯수가 증가하고 관계가 많아져 일부 여러 개의 조인이 걸려야만 데이터를 가져오는 경우가 존재.
  - 업무적으로 조회에 대한 처리성능이 중요하다고 판단될 때 부분적으로 반정규화를 고려
- 설계단계에서 반정규화를 적용하게 되는데 반정규화를 기술적으로 수행하지 않는 경우에는 다음과 같은 현상이 발생
  - 성능이 저하된 데이터베이스가 생성
  - 구축단계나 시험단계에서 반정규화를 적용할 때 수정에 따른 노력비용이 많이 들게 된다.



### 반정규화의 적용방법

1. 반정규화 대상조사
   1. 자주 사용되는 테이블에 접근하는 프로세스의 수가 많고 항상 일정한 범위만을 조회하는 경우에 반정규화를 검토
   2. 테이블에 대량의 데이터가 있고 대량의 데이터 범위를 자주 처리하는 경우에 처리범위가 일정하게 줄이지 않으면 성능을 보장할 수 없는 경우
   3. 통계성 프로세스에 의해 통계 정보를 필요로 할 때 별도의 통계테이블을 생성
   4. 테이블에 지나치게 많은 조인이 걸려 데이터를 조회하는 작업이 기술적으로 어려울 경우
2. 다른 방법유도 검토
   1. 지나치게 많은 조인이 걸려 데이터를 조회하는 작업이 기술적으로 어려운 경우
      1. 뷰를 사용하면 이를 해결할 수도 있다.
      2. 뷰가 조회의 성능을 향상시키는 역할을 수행하지는 않는다.
      3. 다만 개발자별로 SQL문장을 만드는 방법에 따라 성능저하가 나타날 수 잇으므로 성능을 고려한 뷰를 생성하여 개발자가 뷰를 통해 접근하게 함으로 성능저하의 위험을 예방하는 것도 좋은 방법
   2. 대량의 데이터처리나 부분처리에 의해 성능이 저하되는 경우에 클러스터링을 적용하거나 인덱스를 조정함으로써 성능을 향상시킬 수 있다.
      1. 클러스터링을 적용하는 방법은 대량의 데이터를 특정 클러스터링 팩트에 의해 저장방식을 다르게 하는 방법이다.
      2. 이 방법의 경우 데이터를 입력/수정/삭제하는 경우 성능이 많이 저하되므로 조회중심의 테이블이 아니라면 생성하면 안되는 오브젝트이다.
      3. 다만, 조회가 대부분이고 인덱스를 통해 성능향상이 불가능하다면 클러스터링을 고려할 만하다.
      4. 또한, 인덱스를 통해 성능을 충분히 확보할 수 있다면 인덱스를 조정하여 반정규화를 회피하도록 한다.
   3. 대량의 데이터는 PK의 성격에 따라 부분적인 테이블로 분리할 수 있다.
      1. 즉, 파티셔닝 기법이 적용되어 성능저하를 방지할 수 있다.
      2. 인위적인 테이블을 통합/분리하지 않고 물리적인 저장 기법에 따라 성능을 향상시킬 수 있는 파티셔닝을 고려해 볼 수 있다.
      3. 이 경우는 데이터가 특정 기준에 의해 다르게 저장되고 파티셔닝 키에 따른 조회가 될 때 성능이 좋아지는 특성이 있다.
      4. 따라서 특정 기준에 의해 물리적인 저장공간이 구분될 수 있고 트랜잭션이 들어올 때 일정한 기준에 의해 들어온다면 파티셔닝 테이블을 적용하여 조회의 성능을 향상시키는 것도 좋은 방법이 될 수 있다.
   4. 응용 애플리케이션에서 로직을 구사하는 방법을 변경함으로써 성능을 향상시킬 수 있다.
      1. 응용 메모리 영역에 데이터를 처리하기 위한 값을 캐시한다든지 중간 클래스 영역에 데이터를 캐쉬하여 공유하게 하여 성능을 향상 시키는 것도 성능을 향상시키는 방법이 될 수 있다.
3. 반정규화를 적용한다
   1. 세 가지 규칙을 고려하여 반정규화를 적용
      1. 테이블
      2. 속성
      3. 관계
   2. 중복, 추가, 분할을 통해 반정규화를 할 수 있다.



## 반정규화의 기법

### 테이블 반정규화

- 테이블 병합
  - 1:1 관계 테이블병합
  - 1:M 관계 테이블병합
  - 슈퍼/서브타입 테이블병합
- 테이블 분할
  - 수직분할
    - 칼럼단위의 테이블을 디스크I/O를 분산처리하기 위해 테이블을 1:1로 분리하여 성능향상(트랜잭션의 처리되는 유형을 파악이 선행되어야 함)
  - 수평분할
    - 로우 단위로 집중 발생되는 트랜잭션을 분석하여 디스크I/O 및 데이터 접근의 효율성을 높여 성능을 향상하기 위해 로우단위로 테이블을 쪼갬(관계가 없음)
- 테이블 추가
  - 중복테이블 추가
    - 다른 업무이거나 서버가 다른 경우 동일한 테이블구조를 중복하여 원격조인을 제거하여 성능을 향상
  - 통계테이블 추가
    - SUM, AVG 등을 미리 수행하여 계산해 둠으로서 조회 시 성능을 향상
  - 이력테이블 추가
    - 이력테이블 중에서 마스터 테이블에 존재하는 레코드를 중복하여 이력 테이블에 존재하는 방법은 반정규화의 유형
  - 부분테이블 추가
    - 하나의 테이블의 전체 칼럼 중 자주 이용하는데 자주 이용하는 집중화된 칼럼들이 있을 때 디스크 I/O를 줄이기 위해 해당 칼럼들을 모아놓은 별도의 반정규화된 테이블을 생성



### 칼럼 반정규화

- 중복칼럼 추가
  - 조인에 의해 처리할 때 성능저하를 예방하기 위해 즉, 조인을 감소시키기 위해 중복된 칼럼을 위치시킴
- 파생칼럼 추가
  - 트랜잭션이 처리되는 시점에 계산에 의해 발생되는 성능저하를 예방하기 위해 미리 값을 계산하여 칼럼에 보관함
  - Derived Column이라고 함
- 이력테이블 칼럼추가
  - 대량의 이력데이터를 처리할 때 불특정 날 조회나 최근 값을 조회할 때 나타날 수 있는 성능저하를 예방하기 위해 이력테이블에 기능성 칼럼을 추가
- PK에 의한 칼럼 추가
  - 복합의미를 갖는 PK를 단일 속성으로 구성하였을 경우 발생
  - 단일 PK안에서 특정값을 별도로 조회하는 경우 성능저하가 발생
  - 이 때, 이미 PK안에 데이터가 존재하지만 성능향상을 위해 일반속성으로 포함하는 방법이 PK에 의한 칼럼추가 반정규화
- 응용시스템 오작동을 위한 칼럼 추가
  - 업무적으로는 의미가 없지만 사용자가 데이터처리를 하다가 잘못 처리하여 원래 값으로 복구하기를 원하는 경우 이전 데이터를 임시적으로 중복하여 보관하는 기법
  - 칼럼으로 이것을 보관하는 방법은 오작동 처리를 위한 임시적인 기법이지만 이것을 이력데이터 모델로 풀어내면 정상적인 데이터 모델의 기법이 될 수 있다.



### 관계 반정규화

- 중복관계 추가
  - 데이터를 처리하기 위해 여러 경로를 거쳐 조인이 가능하지만 이 때 발생할 수 있는 성능저하를 예방하기 위해 추가적인 관계를 맺는 방법이 관계의 반정규화
- 관계의 반정규화는 데이터 무결성을 깨뜨릴 위험을 갖지 않고서도 데이터처리의 성능을 향상 시킬 수 있는 반정규화의 기법이 된다.
- 데이터 모델 전체가 관계로 연결되어 있고 서로 먼 친척간에 조인관계가 빈번하게 되어 성능저하가 예상이 된다면 관계의 반정규화를 통해 성능향상을 도모할 필요가 있다.














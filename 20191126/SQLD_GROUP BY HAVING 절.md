# SQLD_GROUP BY HAVING 절

## 집계함수

- 특성

  - 여러 행들의 그룹이 모여서 그룹당 단 하나의 결과를 돌려주는 함수
  - GROUP BY 절은 행들을 소그룹화
  - SELECT 절, HAVING 절, ORDER BY 절에 사용

- 자주 사용되는 주요 집계

  - 주로 숫자 유형에 사용

  - MAX, MIN, COUNT 함수는 문자, 날짜 유형에도 적용이 가능

    |   집계 함수    |                        사용 목적                        |
    | :------------: | :-----------------------------------------------------: |
    |    COUNT(*)    |          NULL 값을 포함한 행의 수를 출력한다.           |
    | COUNT(표현식)  | 표현식의 값이 NULL 값인 것을 제외한 행의 수를 출력한다. |
    |     SUM()      |       표현식의 NULL 값을 제외한 합계를 출력한다.        |
    |     AVG()      |        표현식의 NULL값을 제외한 평균을 출력한다.        |
    |     MAX()      |               표현식의 최대값을 출력한다.               |
    |     MIN()      |               표현식의 최소값을 출력한다.               |
    |    STDDEV()    |             표현식의 표준 편차를 출력한다.              |
    |    VARIAN()    |                표현식의 분산을 출력한다.                |
    | 기타 통계 함수 |           벤더별로 다양한 통계식을 제공한다.            |

    

## GROUP BY 절

- FROM 절과 WHERE 절 뒤에 오며, 데이터들을 작은 그룹으로 분류하여 소그룹에 대한 항목별로 통계정보를 얻을 때 추가로 사용
- GROUP BY 절과 HAVING 절의 특성
  - 소그룹별 기준을 정한 후, SELECT 절에 집계 함수 사용
  - 집계 함수의 통계 정보는 NULL 값을 가진 행을 제외하고 수행
  - GROUP BY 절에서는 SELECT 절과는 달리 ALIAS 명을 사용할 수 없음
  - 집계 함수는 WHERE 절에는 올 수 없음
  - WHERE 절은 전체 데이터를 GROUP으로 나누기 전에 행들을 미리 제거
  - HAVING 절은 GROUP BY 절의 기준 항목이나 소그룹의 집계 함수를 이용한 조건을 표시할 수 있음
  - HAVING 절은 일반적으로 GROUP BY 절 뒤에 위치
- 원칙적으로는 ORDER BY 절을 명시해야 데이터 정렬이 수행된다.



## HAVING 절

- WHERE 절에는 AVG()라는 집계 함수는 사용할 수 없다.
- WHERE 절은 FROM 절에 정의된 집합의 개별 행에 WHERE 절의 조건절이 먼저 적용되고, 
- 논리적으로 GROUP BY 절과 HAVING 절의 순서를 지키는 것을 권고
- WHERE 절의 조건 변경은 대상 데이터의 개수가 변경되므로 결과 데이터 값이 변경될 수 있지만, HAVING 절의 조건 변경은 결과 데이터 변경은 없고 출력되는 레코드의 개수만 변경될 수 있다.



## CASE 표현을 활용한 월별 데이터 집계

- 모델링의 제1정규화로 인해 반복되는 칼럼의 경우 구분 칼럼을 두고 여러 개의 레코드로 만들어진 집합을 정해진 칼럼 수만큼 확장해서 집계보고서를 만드는 기법
- 하나의 데이터에 여러 번 CASE 표현을 사용하고 집계 함수가 적용되므로 SQL 처리 성능 측면에서 나쁜 것이 아니냐는 생각을 할 수도 있다.
  - 그렇지만, 같은 기능을 하는 리포트를 작성하기 위해 위 방법을 활용하면 복잡한 프로그램이 아닌 하나의 SQL 문장으로 처리 가능하므로 DBMS 자원 활용이나 처리 속도에서 훨씬 효율적이다.
  - 데이터의 건수가 많아질수록 처리 속도의 차이는 더 커질 수 있다.



## 집계 함수와 NULL 처리

- 다중행 함수에 NVL함수를 사용하면 부하 발생 → 굳이 사용할 필요가 없다.
  - 다중 행 함수는 입력 값으로 전체 건수가 NULL 값인 경우만 함수의 결과가 NULL이 나오고 전체 건수 중에서 일부만 NULL인 경우는 NULL인 행을 다중 행 함수의 대상에서 제외한다.